#include <stdio.h>
#include <string.h>

struct Account {
    int account_no; //unique
    char name[21]; //name of account owner - accounting for null terminator
    char pin[5]; //four digit pin - accounting for null terminator
    int balance; //in dollars
    int balance_cents; //cents of a dollar
};

/* creates a new default account */
int create_account(struct Account *account) {
    account->account_no = 1;
    strncpy(account->name, "Bobby Tables", sizeof(account->name)); //default name
    account->name[sizeof(account->name)-1] = 0;
    strncpy(account->pin, "1234", sizeof(account->pin)); //default pin
    account->pin[sizeof(account->pin)-1] = 0;
    account->balance = 100; //account is registered with a deposit of at least $100
    account->balance_cents = 0;
    return 1; //return 1 for success
}

/*checks the balance on the default account. PIN required */
int check_balance(struct Account *account) {
    char pin_input[4]; //4 digit pin inputed by user
    int pin_attempts = 0; //max attempts is 3
    int pin_success = 0; //initialized to unsuccessful
    int ret = 0; //value to be returned. 0=unsuccessful, 1=successful

    printf("Welcome %s, please enter your PIN: ", account->name);
    do{
        gets(pin_input);
        if( strcmp(pin_input, account->pin) ) {
	    pin_attempts+=1;
            if(pin_attempts<3) {
                printf("\nWrong pin! Please try again: ");
            }else {
                printf("\nThree unsuccessful attempts. Exiting..\n");
                ret = 0;
            }
            
        }else {
            pin_success = 1; //flag successful pin
        }
	if(pin_success) {
	    printf("\n*************Access Granted*************\n");
            printf("Your account balance is %d dollars and %d cents\n", account->balance, account->balance_cents);
	    ret = 1; //change return value to success (1)
	}
	    
    }while(pin_success == 0 && pin_attempts < 3);
    return ret;
}

/*adds funds to default account. Maximum of 999 dollars and 1000 cents */
int add_funds(struct Account *account) {
    int money_input; //input for the whole dollars
    int cents_input; //input for the cents
    int temp_cents; //holds sum of deposited cents + account->balance_cents
    int ret = 0;
    int good_input = 1; //valid input = 1

    printf("First enter the amount of money without cents\nThen, when prompted, enter the amount of cents\n\n");
    printf("Please enter the amount of money to add (without cents): ");

    scanf("%d", &money_input);
    getchar(); //gets rid of trailing '\n'
    if(money_input>999) { //if depositing more than max amount
        printf("Sorry, the maximum accepted is 999\n");
        good_input = 0; //invalid input
        ret = 0; //return false/0
    }else { //money input valid
        printf("Please enter the amount of cents to add: ");
        scanf("%d", &cents_input);
        getchar(); //gets rid of trailing '\n'
        if(cents_input>1000) {
            printf("Sorry, the maximum cents accepted is 1000\n");
            good_input = 0; //invalid input
            ret = 0; //return false/0
        }
    }


    if(good_input) {
        printf("Depositing %d dollars and %d cents!\n", money_input, cents_input);
        account->balance = account->balance + money_input; //update whole dollars
        temp_cents = account->balance_cents + cents_input; //calculate resulting account cents
        int dollars_from_cents = 0; //how many dollars are converted from cents
        if(temp_cents>99) { //if a dollar or more in cents
            do{
                account->balance = account->balance + 1; //put one more dollar
                temp_cents = temp_cents - 100; //decrease the amount of total cents by a dollar
                dollars_from_cents+=1; //one dollar for every 100 cents
            }while(temp_cents>99);
            account->balance_cents = account->balance_cents + temp_cents; //update account cents
            printf("Converted %d dollars from cents.\n", dollars_from_cents);
        }else {
            account->balance_cents = temp_cents; //simply add current cents with deposited cents
        }
        printf("\nNew balance is %d dollars and %d cents!\n", account->balance, account->balance_cents);
        ret = 1;
    }

    return ret;
}

/*removes funds from default account. Maximum of 999 dollars and 1000 cents */
int withdraw_funds(struct Account *account) {
    int money_input;
    char pin_input[4]; //4 digit pin inputed by user
    int pin_attempts = 0; //max attempts is 3
    int pin_success = 0; //initialized to unsuccessful
    int authorized = 0; //value to be returned. 0=unsuccessful, 1=successful
    int ret = 0;

    printf("Please enter your PIN: ");
    do{
        gets(pin_input); //get the input for the pin
        if( strcmp(pin_input, account->pin) == 0 ) { //compare input to stored pin
            pin_success = 1; //flag successful pin
            printf("\n*************Access Granted*************\n");
            authorized = 1; //change return value to success (1)
        }else {
            pin_attempts+=1; //pin attempt increased
            if(pin_attempts<3) {
                printf("\nWrong pin! Please try again: ");
            }else {
                printf("\nThree unsuccessful attempts. Exiting..\n");
                authorized = 0;
            }
        }
    }while(pin_success == 0 && pin_attempts < 3); //while pin is incorrect and less than 3 attempts made

    if(authorized) {
        printf("First enter the amount of money without cents\nThis ATM does not dispense cents\n\n");
        printf("Please enter the amount of money to withdraw (without cents): ");

        scanf("%d", &money_input);
        getchar(); //takes care of trailing '\n'
        if(money_input>999) { //if withdraw more than 999
            printf("Sorry, the maximum accepted is 999\n");
            ret = 0;
        }else { //valid input
            if(account->balance < money_input) { //if not enough money in account
                printf("\nNot enough balance in account! Exiting..\n");
                ret = 0;
            }else{
                account->balance = account->balance - money_input; //update whole dollars in account
                printf("\nNew balance is %d dollars and %d cents!\n", account->balance, account->balance_cents);
                ret = 1;
            }
        }
    }

    return ret;
}

int main() {

    char menu_input; //single character (number)
    struct Account account;
    int create_success = -1; //create account first
    int check_success = -1; //check balance
    int add_success = -1;
    int withdraw_success = -1;
    int exit_loop = 0;

    printf("=============================\n");
    printf("~Welcome to the ATM program!~\n");
    do{
        printf("\n========\n= MENU =\n========\n");
        printf("1. Create an account\n");
        printf("2. Check the balance\n");
        printf("3. Add funds\n");
        printf("4. Withdraw money\n\n");
        printf("h. Help\n");
        printf("q. Exit\n\n");
        printf("Please select an option: ");

        menu_input = getchar();
        if(menu_input!='\n') {
            getchar(); //to remove trailing \n from buffer
        }

        switch(menu_input) {
            case '1': //create account selected
                if(create_success==-1) { //not yet created
                    if(create_success = create_account(&account)) { //create account first and check if successful
                        printf("Account was created successfully!\n");
                    }else {
                        printf("There was a problem creating a default account!\n");
                    }
                }else {
                    printf("There was an error. Most likely the account already exists.\n");
                }
                break;
            case '2': //check balance selected
                if(create_success==1) { //if account was created successfully
                    if(check_success = check_balance(&account)) {
                        printf("Account balance checked successfully!\n");
                    }else {
                        printf("There was a problem checking the account balance.\n");
                    }
                }else{
                    printf("Please create an account first!\n");
                }
                break;
            case '3': //add funds selected
                if(create_success==1) {
                    if(add_success = add_funds(&account)) {
                        printf("Funds added successfully!\n");
                    }else {
                        printf("There was a problem adding funds to the account.\n");
                    }
                }else {
                    printf("Please create an account first!\n");
                }
                break;
            case '4':
                if(create_success==1) {
                    if(withdraw_success = withdraw_funds(&account)) {
                        printf("Withdrawal was successful, enjoy!\n");
                    }else {
                        printf("There was a problem withdrawing funds from the account.\n");
                    }
                }else {
                    printf("Please create an account first!\n");
                }
                break;
            case 'h':
                printf("\n========\n= HELP =\n========\n");
                printf("\nFirst, type one of the options from the menu.\n");
                printf("'1' to create an account\n");
                printf("'2' to check your balance (You'll need an account first and a pin)\n");
                printf("'3' to add funds (You'll need an account first)\n");
                printf("'4' to withdraw money (You'll need an account first and a pin)\n");
                printf("'h' will display this page\n");
                printf("'q' will exit the program\n");
                break;
            case 'q': //exit selected
                exit_loop=1; //set exit condition
                printf("Bye..\n");
                break;
            default:
                printf("\nOption not recognized. Try again!\n");
        }
    }while(exit_loop==0);

    return 1;
}

